<!doctype html>
<html lang="id" class="h-full bg-[#060816] text-gray-200">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>URL Phishing Checker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small custom styles */
    .card { background: rgba(29,33,40,0.9); border-radius: 12px; padding: 18px; }
    .muted { color: #9aa3b2; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px }
  </style>
</head>
<body class="antialiased min-h-screen p-8">
  <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left: Input + redirect chain + heuristics list -->
    <div class="col-span-1 space-y-6">
      <div class="card">
        <label class="block mb-2 muted">Masukkan URL pendek atau URL penuh</label>
        <div class="flex gap-3">
          <input id="urlInput" type="url" placeholder="https://....." class="flex-1 bg-transparent border border-gray-700 rounded-md px-4 py-3 focus:outline-none" />
          <button id="btnAnalyze" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-md">Analyze</button>
        </div>
        <div class="mt-3 text-sm muted">Contoh: https://bit.ly/xxxx atau http://example.com/login</div>
      </div>

      <div id="leftCards" class="space-y-4">
        <div id="resultCard" class="card hidden">
          <div class="text-sm muted">Final URL</div>
          <div id="finalUrl" class="break-words font-medium"></div>
          <div class="mt-3 text-sm muted">Redirect Chain</div>
          <div id="chainList" class="mt-2 space-y-2"></div>
        </div>

        <div id="heurList" class="card hidden">
          <div class="text-sm muted mb-2">Heuristic Indicators</div>
          <div id="heuristicsList" class="space-y-1 text-sm"></div>
        </div>
      </div>
    </div>

    <!-- Right top: Scan Overview -->
    <div class="col-span-2 space-y-4">
      <div class="card">
        <div class="flex justify-between items-start">
          <div>
            <h2 class="text-xl font-semibold">Scan Overview</h2>
            <div class="muted text-sm">Ringkasan cepat dan timeline</div>
          </div>
          <div class="muted">Demo Mode</div>
        </div>

        <div class="mt-4">
          <div class="text-sm muted mb-2">Risk Score</div>
          <div class="w-full h-3 bg-gray-800 rounded-full overflow-hidden">
            <div id="riskBar" class="h-3 rounded-full" style="width:0%"></div>
          </div>
          <div class="mt-2 flex gap-3 items-center text-sm">
            <div><span class="dot" style="background:#34D399"></span> Aman</div>
            <div><span class="dot" style="background:#F59E0B"></span> Waspada</div>
            <div><span class="dot" style="background:#EF4444"></span> Berbahaya</div>
            <div class="ml-auto font-semibold" id="riskText">—</div>
          </div>
        </div>

        <div class="mt-4">
          <div class="text-sm muted">Redirect Timeline</div>
          <div id="timeline" class="mt-2 flex flex-wrap gap-2"></div>
        </div>
      </div>

      <!-- small cards row -->
      <div class="grid grid-cols-3 gap-4">
        <div class="card text-sm">
          <div class="muted">Domain</div>
          <div id="domainBox" class="font-medium mt-2">—</div>
        </div>
        <div class="card text-sm">
          <div class="muted">TLD</div>
          <div id="tldBox" class="font-medium mt-2">—</div>
        </div>
        <div class="card text-sm">
          <div class="muted">Redirects</div>
          <div id="redirectsBox" class="font-medium mt-2">—</div>
        </div>
      </div>

      <div class="card">
        <div class="text-sm muted mb-2">Detailed Heuristics (explainability)</div>
        <div id="details" class="text-sm space-y-1">—</div>
      </div>

      <div id="sslCard" class="card hidden">
        <div class="text-sm muted">SSL / Certificate</div>
        <div id="sslInfo" class="mt-2 text-sm">—</div>
      </div>

      <div id="conclusionCard" class="card hidden">
        <div class="text-sm muted">Kesimpulan</div>
        <div id="conclusionText" class="mt-2 font-medium"></div>
        <ul id="adviceList" class="mt-2 text-sm space-y-1"></ul>
      </div>
    </div>
  </div>

<script>
  const $ = id => document.getElementById(id);

  function setRisk(score) {
    const bar = $('riskBar');
    const pct = Math.max(0, Math.min(100, score));
    bar.style.width = pct + '%';

    if (pct >= 75) {
      bar.style.background = '#EF4444'; // red
      $('riskText').textContent = pct + '/100 — Berbahaya';
    } else if (pct >= 40) {
      bar.style.background = '#F59E0B'; // yellow
      $('riskText').textContent = pct + '/100 — Waspada';
    } else {
      bar.style.background = '#34D399'; // green
      $('riskText').textContent = pct + '/100 — Aman';
    }
  }

  function renderResult(data) {
    if(!data) return;
    // show result card
    $('resultCard').classList.remove('hidden');
    $('heurList').classList.remove('hidden');

    $('finalUrl').textContent = data.final_url || data.input;
    // chain
    const chainDiv = $('chainList'); chainDiv.innerHTML = '';
    (data.redirect_chain || []).forEach((u,i) => {
      const el = document.createElement('div');
      el.className = "text-sm bg-[#0E1116] p-2 rounded";
      el.textContent = (i+1) + '. ' + u;
      chainDiv.appendChild(el);
    });

    // timeline chips
    const timeline = $('timeline'); timeline.innerHTML = '';
    (data.redirect_chain || []).forEach((u,i) => {
      const chip = document.createElement('div');
      chip.className = 'px-3 py-1 rounded bg-[#0E1116] text-sm';
      chip.textContent = (i+1) + '. ' + (u.length>40 ? u.slice(0,38)+'…': u);
      timeline.appendChild(chip);
    });

    // top small boxes
    $('domainBox').textContent = data.domain || '—';
    $('tldBox').textContent = data.tld || '—';
    $('redirectsBox').textContent = data.redirect_count ?? '—';

    // heuristics list
    const hl = $('heuristicsList'); hl.innerHTML = '';
    const heur = data.heuristics || {};
    const rows = [
      ['Panjang URL', heur.length],
      ['TLD', heur.tld],
      ['Brand keywords', (heur.contains_brand ? 'Yes' : 'No')],
      ['Redirect count', heur.redirects],
      ['SSL present', heur.ssl_present ? 'Yes' : 'No'],
      ['Host entropy', heur.host_entropy?.toFixed ? heur.host_entropy.toFixed(2) : heur.host_entropy]
    ];
    rows.forEach(r => {
      const div = document.createElement('div');
      div.className = 'flex justify-between bg-[#0B0E12] p-2 rounded';
      div.innerHTML = `<span class="text-gray-300">${r[0]}</span><span class="text-gray-400">${r[1] ?? '-'}</span>`;
      hl.appendChild(div);
    });

    // detailed
    const det = $('details'); det.innerHTML = '';
    det.innerHTML = `
      <div>URL length: ${heur.length}</div>
      <div>TLD: ${heur.tld}</div>
      <div>Brand keywords: ${heur.contains_brand ? 'Yes' : 'No'}</div>
      <div>Redirect count: ${heur.redirects}</div>
      <div>SSL present: ${heur.ssl_present ? 'Yes' : 'No'}</div>
    `;

    // SSL card
    if(data.ssl && data.ssl.valid){
      $('sslCard').classList.remove('hidden');
      $('sslInfo').innerHTML = `Issuer: ${data.ssl.issuer} — Expires in: ${data.ssl.expires_in_days ?? 'N/A'} days`;
    } else {
      $('sslCard').classList.add('hidden');
    }

    // conclusion + advice
    $('conclusionCard').classList.remove('hidden');
    $('conclusionText').textContent = `${data.risk_label} — score ${data.risk_score}/100`;
    const adv = $('adviceList'); adv.innerHTML = '';
    (data.advice?.dont || []).forEach(t => {
      const li = document.createElement('li'); li.textContent = '❌ ' + t; adv.appendChild(li);
    });
    (data.advice?.do || []).forEach(t => {
      const li = document.createElement('li'); li.textContent = '✅ ' + t; adv.appendChild(li);
    });

    setRisk(data.risk_score ?? 0);
  }

  async function doScan(url) {
    try {
      const res = await fetch('/scan', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({url})
      });
      if(!res.ok) throw new Error('scan failed');
      return await res.json();
    } catch(e){
      console.error(e);
      alert('Scan gagal. Cek console.');
      return null;
    }
  }

  $('btnAnalyze').addEventListener('click', async () => {
    const url = $('urlInput').value.trim();
    if(!url) return alert('Masukkan URL');
    $('btnAnalyze').disabled = true; $('btnAnalyze').textContent = 'Analyzing...';
    const data = await doScan(url);
    if(data) renderResult(data);
    $('btnAnalyze').disabled = false; $('btnAnalyze').textContent = 'Analyze';
  });
</script>
</body>
</html>